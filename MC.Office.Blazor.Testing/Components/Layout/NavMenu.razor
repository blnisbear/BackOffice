@inject NavigationManager NavigationManager
@implements IDisposable

<div class="navigation-menu">
    @* Menu Tree *@
    @* <DxTreeView Data="@FilteredMenuItems"
                CssClass="menu-treeview"
                UrlMatchMode="NavigationUrlMatchMode.Exact"
                AllowSelectNodes="true"
                NodeExpandCollapseAction="TreeViewNodeExpandCollapseAction.NodeClick"
                ShowExpandButtons="true"
                AnimationType="LayoutAnimationType.Slide"> *@

    <DxTreeView Data="@FilteredMenuItems"
                @bind-ExpandedDataItems="@ExpandedItems"
                CssClass="menu-treeview"
                UrlMatchMode="NavigationUrlMatchMode.Exact"
                AllowSelectNodes="true"
                NodeExpandCollapseAction="TreeViewNodeExpandCollapseAction.NodeClick"
                ShowExpandButtons="true"
                AnimationType="LayoutAnimationType.Slide">

        <DataMappings>
            <DxTreeViewDataMapping Key="Id"
                                   Text="Text"
                                   ParentKey="ParentId"
                                   IconCssClass="IconCssClass"
                                   NavigateUrl="NavigateUrl"
                                   HasChildren="HasChildren" />
        </DataMappings>

        @* <NodeTemplate>
            @{
                var item = (MenuItem)context.DataItem;
                var isExpanded = context.Expanded; // เพิ่มบรรทัดนี้

                if (item.IsGroupHeader)
                {
                    <div class="menu-group-header">
                        @if (item.HasChildren)
                        {
                            // เพิ่มคลาส expanded เมื่อ node ถูก expand
                            <i class="expand-icon fa-solid fa-chevron-right @(isExpanded ? "expanded" : "")"></i>
                        }
                        <span>@item.Text</span>
                    </div>
                }
                else
                {
                    <div class="menu-node-content" @onclick="@(() => NavigateToUrl(item.NavigateUrl))">
                        @if (!string.IsNullOrEmpty(item.IconCssClass))
                        {
                            <i class="@item.IconCssClass menu-icon"></i>
                        }
                        <span class="menu-text">@item.Text</span>
                        @if (item.IsNew)
                        {
                            <span class="menu-new-label">New</span>
                        }
                        @if (item.HasBadge)
                        {
                            <span class="menu-badge"></span>
                        }
                    </div>
                }
            }
        </NodeTemplate> *@
        <NodeTemplate>
            @{
                var item = (MenuItem)context.DataItem;
                var isExpanded = context.Expanded;

                if (item.IsGroupHeader)
                {
                    <div class="menu-group-header">
                        @if (item.HasChildren)
                        {
                            <i class="expand-icon fa-solid fa-chevron-right @(isExpanded ? "expanded" : "")"></i>
                        }
                        <span>@item.Text</span>
                    </div>
                }
                else
                {
                    <div class="menu-node-content" @onclick="@(() => NavigateToUrl(item.NavigateUrl))">
                        @if (!string.IsNullOrEmpty(item.IconCssClass))
                        {
                            <i class="@item.IconCssClass menu-icon"></i>
                        }
                        <span class="menu-text">@((MarkupString)HighlightText(item.Text))</span>
                        @if (item.IsNew)
                        {
                            <span class="menu-new-label">New</span>
                        }
                        @if (item.HasBadge)
                        {
                            <span class="menu-badge"></span>
                        }
                    </div>
                }
            }
        </NodeTemplate>
    </DxTreeView>
</div>

@code {
    [Parameter] public string SearchText { get; set; } = "";

    private MenuItem? SelectedItem;
    private string? currentLocalPath;
    
    private List<MenuItem> MenuItems = new();
    private IEnumerable<object>? ExpandedItems; // เพิ่มบรรทัดนี้

    private List<MenuItem> FilteredMenuItems =>
        string.IsNullOrWhiteSpace(SearchText)
            ? MenuItems
            : MenuItems.Where(m =>
                m.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                (m.IsGroupHeader && MenuItems.Any(child =>
                    child.ParentId == m.Id &&
                    child.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase)))
            ).ToList();

    protected override void OnInitialized()
    {
        InitializeMenuItems();
        UpdateSelectedItem();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    private void InitializeMenuItems()
    {
        MenuItems = new List<MenuItem>
        {
            // Main items
            new MenuItem { Id = "home", Text = "Home", NavigateUrl = "/", IconCssClass = "dx-icon-home" },
            new MenuItem { Id = "counter", Text = "Counter", NavigateUrl = "/counter", IconCssClass = "dx-icon-refresh" },
            new MenuItem { Id = "weather", Text = "Weather", NavigateUrl = "/weather", IconCssClass = "dx-icon-cloud" },

            // AI-powered Extensions
            new MenuItem { Id = "ai-group", Text = "AI-powered Extensions", IsGroupHeader = true, HasChildren = true },
            new MenuItem { Id = "ai-chat", ParentId = "ai-group", Text = "AI Chat", NavigateUrl = "/ai-chat", IconCssClass = "fa-solid fa-comments", HasBadge = true },
            new MenuItem { Id = "rich-editor", ParentId = "ai-group", Text = "Rich Text Editor", NavigateUrl = "/rich-editor", IconCssClass = "fa-solid fa-file-pen" },
            new MenuItem { Id = "html-editor", ParentId = "ai-group", Text = "HTML Editor", NavigateUrl = "/html-editor", IconCssClass = "fa-solid fa-code" },
            new MenuItem { Id = "memo", ParentId = "ai-group", Text = "Memo", NavigateUrl = "/memo", IconCssClass = "fa-solid fa-note-sticky", IsNew = true },
            new MenuItem { Id = "grid-ai", ParentId = "ai-group", Text = "Grid", NavigateUrl = "/grid-ai", IconCssClass = "fa-solid fa-table" },
            new MenuItem { Id = "reports", ParentId = "ai-group", Text = "Reports", NavigateUrl = "/reports", IconCssClass = "fa-solid fa-chart-line" },

            // Data Management
            new MenuItem { Id = "data-mgmt", Text = "Data Management", IsGroupHeader = true, HasChildren = true },
            new MenuItem { Id = "grid-data", ParentId = "data-mgmt", Text = "Grid", NavigateUrl = "/grid", IconCssClass = "fa-solid fa-table-cells", HasBadge = true },
            new MenuItem { Id = "treelist", ParentId = "data-mgmt", Text = "TreeList", NavigateUrl = "/treelist", IconCssClass = "fa-solid fa-sitemap", HasBadge = true },
            new MenuItem { Id = "filter-builder", ParentId = "data-mgmt", Text = "Filter Builder", NavigateUrl = "/filter", IconCssClass = "fa-solid fa-filter", HasBadge = true },

            // Data Editors
            new MenuItem { Id = "data-editors", Text = "Data Editors", IsGroupHeader = true, HasChildren = true },
            new MenuItem { Id = "overview", ParentId = "data-editors", Text = "Overview", NavigateUrl = "/overview", IconCssClass = "fa-solid fa-circle-info" },
            new MenuItem { Id = "common-concepts", ParentId = "data-editors", Text = "Common Concepts", NavigateUrl = "/concepts", IconCssClass = "fa-solid fa-lightbulb" },
            new MenuItem { Id = "calendar", ParentId = "data-editors", Text = "Calendar", NavigateUrl = "/calendar", IconCssClass = "fa-solid fa-calendar" },
            new MenuItem { Id = "checkbox", ParentId = "data-editors", Text = "CheckBox", NavigateUrl = "/checkbox", IconCssClass = "fa-solid fa-square-check" },
            new MenuItem { Id = "color-palette", ParentId = "data-editors", Text = "Color Palette", NavigateUrl = "/colors", IconCssClass = "fa-solid fa-palette" },
            new MenuItem { Id = "combobox", ParentId = "data-editors", Text = "ComboBox", NavigateUrl = "/combobox", IconCssClass = "fa-solid fa-list" },
            new MenuItem { Id = "date-edit", ParentId = "data-editors", Text = "Date Edit", NavigateUrl = "/date", IconCssClass = "fa-solid fa-calendar-days" },
            new MenuItem { Id = "date-range", ParentId = "data-editors", Text = "Date Range Picker", NavigateUrl = "/daterange", IconCssClass = "fa-solid fa-calendar-week" },
            new MenuItem { Id = "dropdown", ParentId = "data-editors", Text = "DropDown Box", NavigateUrl = "/dropdown", IconCssClass = "fa-solid fa-caret-down" }
        };
    }

    // private void UpdateSelectedItem()
    // {
    //     currentLocalPath = new Uri(NavigationManager.Uri).LocalPath;
    //     SelectedItem = MenuItems.FirstOrDefault(m =>
    //         !string.IsNullOrEmpty(m.NavigateUrl) &&
    //         string.Equals(m.NavigateUrl, currentLocalPath, StringComparison.OrdinalIgnoreCase));
    // }

    private void UpdateSelectedItem()
    {
        currentLocalPath = new Uri(NavigationManager.Uri).LocalPath;

        SelectedItem = MenuItems.FirstOrDefault(m =>
            !string.IsNullOrEmpty(m.NavigateUrl) &&
            string.Equals(m.NavigateUrl, currentLocalPath, StringComparison.OrdinalIgnoreCase));

        BuildBreadcrumb(SelectedItem); // ⭐ เพิ่มบรรทัดนี้
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateSelectedItem();
        InvokeAsync(StateHasChanged);
    }

    private void NavigateToUrl(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            NavigationManager.NavigateTo(url);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    public class MenuItem
    {
        public string Id { get; set; } = "";
        public string? ParentId { get; set; }
        public string Text { get; set; } = "";
        public string? NavigateUrl { get; set; }
        public string? IconCssClass { get; set; }
        public bool IsGroupHeader { get; set; }
        public bool IsNew { get; set; }
        public bool HasBadge { get; set; }
        public bool HasChildren { get; set; }
    }

    #region Breadcrumb
    public List<MenuItem> BreadcrumbItems = new();

    private void BuildBreadcrumb(MenuItem? selected)
    {
        BreadcrumbItems.Clear();

        // ⭐ เพิ่ม Home เป็นตัวแรก
        var home = MenuItems.FirstOrDefault(x => x.Id == "home");
        if (home != null)
            BreadcrumbItems.Add(home);

        if (selected == null)
            return;

        var stack = new Stack<MenuItem>();
        var current = selected;

        while (current != null && current.Id != "home")
        {
            stack.Push(current);
            current = string.IsNullOrEmpty(current.ParentId)
                ? null
                : MenuItems.FirstOrDefault(x => x.Id == current.ParentId);
        }

        while (stack.Any())
            BreadcrumbItems.Add(stack.Pop());
    }
    #endregion

    private string _previousSearchText = "";

    // ⭐ เพิ่ม method สำหรับ highlight
    private string HighlightText(string text)
    {
        if (string.IsNullOrWhiteSpace(SearchText) || string.IsNullOrWhiteSpace(text))
            return text;

        var index = text.IndexOf(SearchText, StringComparison.OrdinalIgnoreCase);
        if (index == -1)
            return text;

        var before = text.Substring(0, index);
        var match = text.Substring(index, SearchText.Length);
        var after = text.Substring(index + SearchText.Length);

        return $"{before}<mark class='search-highlight'>{match}</mark>{after}";
    }

}