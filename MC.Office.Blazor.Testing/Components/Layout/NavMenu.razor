@using MC.Office.Blazor.Testing.Components.Layout.MockData.NavMenu

@inject NavigationManager NavigationManager
@inject MenuDataService MenuDataService
@implements IDisposable

<div class="navigation-menu">
    <DxTreeView Data="@FilteredMenuItems"
                @bind-ExpandedDataItems="@ExpandedItems"
                CssClass="menu-treeview"
                UrlMatchMode="NavigationUrlMatchMode.Exact"
                AllowSelectNodes="true"
                NodeExpandCollapseAction="TreeViewNodeExpandCollapseAction.NodeClick"
                ShowExpandButtons="false"
                AnimationType="LayoutAnimationType.Slide">

        <DataMappings>
            <DxTreeViewDataMapping Key="Id"
                                   Text="Text"
                                   ParentKey="ParentId"
                                   IconCssClass="IconCssClass"
                                   NavigateUrl="NavigateUrl"
                                   HasChildren="HasChildren" />
        </DataMappings>
        <NodeTemplate>
            @{
                var item = (MenuItem)context.DataItem;
                var isExpanded = context.Expanded;

                if (item.IsGroupHeader)
                {
                    <div class="menu-group-header" @onclick="@(() => ToggleExpand(item))">
                        <i class="expand-icon fa-solid fa-chevron-right @(isExpanded ? "expanded" : "")"></i>
                        <i class="fa-solid fa-folder@(isExpanded ? "-open" : "") menu-folder-icon"></i>
                        <span>@item.Text</span>
                    </div>
                }
                else
                {
                    <div class="menu-node-content" @onclick="@(() => NavigateToUrl(item.NavigateUrl))">
                        @if (!string.IsNullOrEmpty(item.IconCssClass))
                        {
                            <i class="@item.IconCssClass menu-icon"></i>
                        }
                        <span class="menu-text">@item.Text</span>
                        @if (item.IsNew)
                        {
                            <span class="menu-new-label">New</span>
                        }
                        @if (item.HasBadge)
                        {
                            <span class="menu-badge"></span>
                        }
                    </div>
                }
            }
        </NodeTemplate>
    </DxTreeView>
</div>

@code {
    [Parameter] public string SelectedMenuCategory { get; set; } = "";

    string SearchText { get; set; } = "";

    private MenuItem? SelectedItem;
    private string? currentLocalPath;

    private List<MenuItem> MenuItems = new();
    private IEnumerable<object>? ExpandedItems;

    private List<MenuItem> FilteredMenuItems =>
        string.IsNullOrWhiteSpace(SearchText)
            ? MenuItems
            : MenuItems.Where(m =>
                m.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase) ||
                (m.IsGroupHeader && MenuItems.Any(child =>
                    child.ParentId == m.Id &&
                    child.Text.Contains(SearchText, StringComparison.OrdinalIgnoreCase)))
            ).ToList();

    protected override void OnInitialized()
    {
        InitializeMenuItems();
        UpdateSelectedItem();
        NavigationManager.LocationChanged += OnLocationChanged;
    }

    protected override void OnParametersSet()
    {
        InitializeMenuItems();
        StateHasChanged();
    }

    private void InitializeMenuItems()
    {
        MenuItems = MenuDataService.GetMenuItems(SelectedMenuCategory);
    }

    private void ToggleExpand(MenuItem item)
    {
        var expandedList = ExpandedItems?.ToList() ?? new List<object>();

        if (expandedList.Contains(item))
        {
            expandedList.Remove(item);
        }
        else
        {
            expandedList.Add(item);
        }

        ExpandedItems = expandedList;
    }

    private void UpdateSelectedItem()
    {
        currentLocalPath = new Uri(NavigationManager.Uri).LocalPath;

        SelectedItem = MenuItems.FirstOrDefault(m =>
            !string.IsNullOrEmpty(m.NavigateUrl) &&
            string.Equals(m.NavigateUrl, currentLocalPath, StringComparison.OrdinalIgnoreCase));

        BuildBreadcrumb(SelectedItem);
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateSelectedItem();
        InvokeAsync(StateHasChanged);
    }

    private void NavigateToUrl(string? url)
    {
        if (!string.IsNullOrEmpty(url))
        {
            NavigationManager.NavigateTo(url);
        }
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

    #region Breadcrumb
    public List<MenuItem> BreadcrumbItems = new();

    private void BuildBreadcrumb(MenuItem? selected)
    {
        BreadcrumbItems.Clear();

        var home = MenuItems.FirstOrDefault(x => x.Id == "home");
        if (home != null)
            BreadcrumbItems.Add(home);

        if (selected == null)
            return;

        var stack = new Stack<MenuItem>();
        var current = selected;

        while (current != null && current.Id != "home")
        {
            stack.Push(current);
            current = string.IsNullOrEmpty(current.ParentId)
                ? null
                : MenuItems.FirstOrDefault(x => x.Id == current.ParentId);
        }

        while (stack.Any())
            BreadcrumbItems.Add(stack.Pop());
    }
    #endregion
}